import { query } from "@anthropic-ai/claude-agent-sdk";
import { readFileSync, existsSync, mkdirSync, writeFileSync } from "fs";
import { join } from "path";

// ƒê·∫£m b·∫£o folder output t·ªìn t·∫°i
const outputDir = join(process.cwd(), "output");
if (!existsSync(outputDir)) {
  mkdirSync(outputDir, { recursive: true });
  console.log("üìÅ Created output directory");
}

// ƒê·ªçc prompt t·ª´ file .md
const promptPath = join(process.cwd(), "prompt.md");

if (!existsSync(promptPath)) {
  console.error("‚ùå File prompt.md kh√¥ng t·ªìn t·∫°i!");
  console.log("üí° Vui l√≤ng t·∫°o file prompt.md v·ªõi y√™u c·∫ßu query c·ªßa b·∫°n.");
  process.exit(1);
}

const prompt = readFileSync(promptPath, "utf-8");

console.log("üöÄ Starting MGS Query Generator...");
console.log("üìù Reading prompt from:", promptPath);
console.log("=" .repeat(60));
console.log(prompt);
console.log("=".repeat(60));
console.log("");

// Bi·∫øn ƒë·ªÉ l∆∞u k·∫øt qu·∫£ cu·ªëi c√πng
let finalResult = [];
let conversationLog = [];

try {
for await (const message of query({
  prompt: prompt,
  options: {
    model: "sonnet",
    cwd: process.cwd(),
    settingSources: ["project"],
    allowedTools: ["Skill", "Read", "Write", "Bash", "Glob", "Edit"]
  }
})) {
  // Print human-readable output
  if (message.type === "assistant" && message.message?.content) {
    for (const block of message.message.content) {
      if ("text" in block) {
        const text = block.text;
        console.log(text);
        conversationLog.push({
          type: "assistant",
          content: text,
          timestamp: new Date().toISOString()
        });

        // Collect t·∫•t c·∫£ text responses
        finalResult.push(text);
      } else if ("name" in block) {
        console.log(`\nüîß Tool: ${block.name}`);
        conversationLog.push({
          type: "tool",
          tool: block.name,
          timestamp: new Date().toISOString()
        });
      }
    }
  } else if (message.type === "result") {
    console.log(`\n‚úÖ Done: ${message.subtype}`);
  } else if (message.type === "error") {
    const errorMsg = message.error?.message || "Unknown error";
    console.error(`\n‚ùå Error: ${errorMsg}`);
    finalResult.push(`## Error\n\n${errorMsg}`);
  }
}
} catch (err) {
  console.error(`\nüí• Fatal error: ${err.message}`);
  finalResult.push(`## Fatal Error\n\n${err.message}`);
}

// Ghi k·∫øt qu·∫£ cu·ªëi c√πng v√†o file
const outputPath = join(outputDir, "query-result.md");

// T·∫°o n·ªôi dung output
const outputContent = `# MGS Query Result

**Generated at**: ${new Date().toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' })}

**Prompt**:
\`\`\`
${prompt}
\`\`\`

---

## Result

${finalResult.join("\n\n")}

---

*Generated by MGS Query Agent SDK*
`;

writeFileSync(outputPath, outputContent, "utf-8");

console.log("\n" + "=".repeat(60));
console.log("‚úÖ Query generation completed!");
console.log("üìÑ Output saved to:", outputPath);
console.log("=".repeat(60));
