import { query } from "@anthropic-ai/claude-agent-sdk";
import { readFileSync, existsSync, mkdirSync, writeFileSync } from "fs";
import { join } from "path";

// FIXED: Removed hardcoded secret key - use environment variable instead
// Validate SECRET_KEY is set and has minimum length
const secretKey = process.env.SECRET_KEY
if (!secretKey) {
  throw new Error('SECRET_KEY environment variable must be set. Generate one using: openssl rand -hex 32')
}
if (secretKey.length < 32) {
  throw new Error('SECRET_KEY must be at least 32 characters long for security. Current length: ' + secretKey.length)
}

// aaa

// Äáº£m báº£o folder output tá»“n táº¡i
const outputDir = join(process.cwd(), "output");
if (!existsSync(outputDir)) {
  mkdirSync(outputDir, { recursive: true });
  console.log("ðŸ“ Created output directory");
}
// test agent openclaw
// test agent openclaw 2
// test agent openclaw 3
// test agent openclaw 4
// test agent openclaw 5
// test agent openclaw 6
// test agent openclaw 7
// test agent openclaw 8
// test agent openclaw 9
// test agent openclaw 10
// Äá»c prompt tá»« file .md
// Äá»c prompt tá»« file .md
const promptPath = join(process.cwd(), "prompt.md");

if (!existsSync(promptPath)) {
  console.error("âŒ File prompt.md khÃ´ng tá»“n táº¡i!");
  console.log("ðŸ’¡ Vui lÃ²ng táº¡o file prompt.md vá»›i yÃªu cáº§u query cá»§a báº¡n.");
  process.exit(1);
}

const prompt = readFileSync(promptPath, "utf-8");

console.log("ðŸš€ Starting MGS Query Generator...");
console.log("ðŸ“ Reading prompt from:", promptPath);
console.log("=" .repeat(60));
console.log(prompt);
console.log("=".repeat(60));
console.log("");

// Biáº¿n Ä‘á»ƒ lÆ°u káº¿t quáº£ cuá»‘i cÃ¹ng
let finalResult = [];
let conversationLog = [];

try {
for await (const message of query({
  prompt: prompt,
  options: {
    model: "sonnet",
    cwd: process.cwd(),
    settingSources: ["project"],
    allowedTools: ["Skill", "Read", "Write", "Bash", "Glob", "Edit"]
  }
})) {
  // Print human-readable output
  if (message.type === "assistant" && message.message?.content) {
    for (const block of message.message.content) {
      if ("text" in block) {
        const text = block.text;
        console.log(text);
        conversationLog.push({
          type: "assistant",
          content: text,
          timestamp: new Date().toISOString()
        });

        // Collect táº¥t cáº£ text responses
        finalResult.push(text);
      } else if ("name" in block) {
        console.log(`\nðŸ”§ Tool: ${block.name}`);
        conversationLog.push({
          type: "tool",
          tool: block.name,
          timestamp: new Date().toISOString()
        });
      }
    }
  } else if (message.type === "result") {
    console.log(`\nâœ… Done: ${message.subtype}`);
  } else if (message.type === "error") {
    const errorMsg = message.error?.message || "Unknown error";
    console.error(`\nâŒ Error: ${errorMsg}`);
    finalResult.push(`## Error\n\n${errorMsg}`);
  }
}
} catch (err) {
  console.error(`\nðŸ’¥ Fatal error: ${err.message}`);
  finalResult.push(`## Fatal Error\n\n${err.message}`);
}

// Ghi káº¿t quáº£ cuá»‘i cÃ¹ng vÃ o file
const outputPath = join(outputDir, "query-result.md");

// Táº¡o ná»™i dung output
const outputContent = `# MGS Query Result

**Generated at**: ${new Date().toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' })}

**Prompt**:
\`\`\`
${prompt}
\`\`\`

---

## Result

${finalResult.join("\n\n")}

---

*Generated by MGS Query Agent SDK*
`;

writeFileSync(outputPath, outputContent, "utf-8");

console.log("\n" + "=".repeat(60));
console.log("âœ… Query generation completed!");
console.log("ðŸ“„ Output saved to:", outputPath);
console.log("=".repeat(60));
